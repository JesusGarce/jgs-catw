---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Categor√≠as - Twitter Archiver">
  <div class="px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Categor√≠as</h1>
      <p class="mt-2 text-gray-600">Gestiona las categor√≠as para organizar tus tweets.</p>
    </div>

    <!-- AI Categorization Controls -->
    <div class="card mb-8">
      <h3 class="text-lg font-medium text-gray-900 mb-4">ü§ñ Categorizaci√≥n Autom√°tica con IA</h3>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div>
          <button id="autoCreateCategories" class="btn-primary w-full">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            Crear Categor√≠as Autom√°ticamente
          </button>
          <p class="text-xs text-gray-500 mt-1">Analiza tus tweets y crea categor√≠as inteligentes</p>
        </div>
        
        <div>
          <button id="recategorizeTweets" class="btn-secondary w-full">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Recategorizar Tweets
          </button>
          <p class="text-xs text-gray-500 mt-1">Reclasifica todos tus tweets con IA</p>
        </div>
        
        <div>
          <button id="initializeAI" class="btn-outline w-full">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Inicializar IA
          </button>
          <p class="text-xs text-gray-500 mt-1">Cargar modelo de IA para categorizaci√≥n</p>
        </div>
      </div>
    </div>

    <!-- Manual Category Creation (Collapsed by default) -->
    <div class="card mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Crear Categor√≠a Manual</h3>
        <button id="toggleManualForm" class="text-sm text-primary-600 hover:text-primary-800">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
      </div>
      <div id="manualFormContainer" class="hidden">
        <form id="addCategoryForm" class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <div>
            <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
            <input type="text" id="categoryName" placeholder="Ej: Tecnolog√≠a" class="input" required>
          </div>
          
          <div>
            <label for="categoryDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
            <input type="text" id="categoryDescription" placeholder="Descripci√≥n opcional" class="input">
          </div>
          
          <div>
            <label for="categoryColor" class="block text-sm font-medium text-gray-700 mb-1">Color</label>
            <input type="color" id="categoryColor" value="#3B82F6" class="input h-10">
          </div>
          
          <div class="flex items-end">
            <button type="submit" class="btn-primary w-full">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Crear Categor√≠a
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Categories List -->
    <div class="card">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Categor√≠as Existentes</h3>
      <div id="categoriesContainer" class="space-y-4">
        <!-- Loading state -->
        <div id="loadingState" class="text-center py-12">
          <svg class="animate-spin mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="mt-2 text-gray-500">Cargando categor√≠as...</p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // API base URL
  const API_BASE = 'http://127.0.0.1:3001';
  
  // Check authentication
  async function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
      window.location.href = '/';
      return false;
    }
    return true;
  }
  
  // Load categories
  async function loadCategories() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    try {
      const response = await fetch(`${API_BASE}/api/v1/categories`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        displayCategories(data.categories || []);
      } else {
        throw new Error('Error loading categories');
      }
    } catch (error) {
      console.error('Error:', error);
      document.getElementById('categoriesContainer').innerHTML = `
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          <p class="mt-2 text-gray-500">Error cargando categor√≠as</p>
        </div>
      `;
    } finally {
      document.getElementById('loadingState').style.display = 'none';
    }
  }
  
  // Display categories
  function displayCategories(categories) {
    const container = document.getElementById('categoriesContainer');
    
    if (!categories || categories.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
          <p class="mt-2 text-gray-500">No hay categor√≠as creadas</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = categories.map(category => `
      <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow">
        <div class="flex items-center space-x-4">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-full" style="background-color: ${category.color}"></div>
          </div>
          <div>
            <h4 class="text-sm font-medium text-gray-900">${category.name}</h4>
            <p class="text-sm text-gray-500">${category.description || 'Sin descripci√≥n'}</p>
          </div>
        </div>
        
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <p class="text-sm font-medium text-gray-900">${category.tweetCount || 0} tweets</p>
            <p class="text-xs text-gray-500">
              ${category.isDefault ? 'Categor√≠a por defecto' : 
                category.description && category.description.includes('generada autom√°ticamente') ? 
                'ü§ñ Generada por IA' : 'Personalizada'}
            </p>
          </div>
          
          <div class="flex items-center space-x-2">
            <button onclick="editCategory('${category.id}')" class="text-sm text-primary-600 hover:text-primary-800">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
            
            ${!category.isDefault ? `
              <button onclick="deleteCategory('${category.id}')" class="text-sm text-red-600 hover:text-red-800">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // Add category
  async function addCategory(event) {
    event.preventDefault();
    
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    const name = document.getElementById('categoryName').value.trim();
    const description = document.getElementById('categoryDescription').value.trim();
    const color = document.getElementById('categoryColor').value;
    
    if (!name) {
      alert('El nombre de la categor√≠a es requerido');
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE}/api/v1/categories`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name,
          description,
          color
        })
      });
      
      if (response.ok) {
        // Reset form
        document.getElementById('addCategoryForm').reset();
        document.getElementById('categoryColor').value = '#3B82F6';
        
        // Reload categories
        loadCategories();
        
        alert('Categor√≠a creada exitosamente');
      } else {
        const error = await response.json();
        alert(error.error || 'Error creando categor√≠a');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error creando categor√≠a');
    }
  }
  
  // Edit category
  async function editCategory(categoryId) {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    const newName = prompt('Nuevo nombre de la categor√≠a:');
    if (!newName) return;
    
    const newDescription = prompt('Nueva descripci√≥n (opcional):');
    const newColor = prompt('Nuevo color (hex, opcional):', '#3B82F6');
    
    try {
      const response = await fetch(`${API_BASE}/api/v1/categories/${categoryId}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: newName,
          description: newDescription,
          color: newColor
        })
      });
      
      if (response.ok) {
        loadCategories();
        alert('Categor√≠a actualizada exitosamente');
      } else {
        const error = await response.json();
        alert(error.error || 'Error actualizando categor√≠a');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error actualizando categor√≠a');
    }
  }
  
  // Delete category
  async function deleteCategory(categoryId) {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta categor√≠a? Los tweets asociados se mover√°n a la categor√≠a "General".')) {
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE}/api/v1/categories/${categoryId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        loadCategories();
        alert('Categor√≠a eliminada exitosamente');
      } else {
        const error = await response.json();
        alert(error.error || 'Error eliminando categor√≠a');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error eliminando categor√≠a');
    }
  }
  
  // Auto create categories with AI
  async function autoCreateCategories() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    const button = document.getElementById('autoCreateCategories');
    const originalText = button.innerHTML;
    
    try {
      button.disabled = true;
      button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Analizando tweets...
      `;
      
      const response = await fetch(`${API_BASE}/api/v1/categories/auto-create`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        alert(`‚úÖ Categorizaci√≥n autom√°tica completada!\n\nüìä Resultados:\n‚Ä¢ Categor√≠as creadas: ${data.result.created}\n‚Ä¢ Tweets categorizados: ${data.result.categorized}\n‚Ä¢ Total procesados: ${data.result.totalProcessed}`);
        loadCategories();
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Error en categorizaci√≥n autom√°tica'}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error en categorizaci√≥n autom√°tica');
    } finally {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
  
  // Recategorize all tweets
  async function recategorizeTweets() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    if (!confirm('¬øEst√°s seguro de que quieres recategorizar todos tus tweets? Esto puede tomar varios minutos.')) {
      return;
    }
    
    const button = document.getElementById('recategorizeTweets');
    const originalText = button.innerHTML;
    
    try {
      button.disabled = true;
      button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Recategorizando...
      `;
      
      const response = await fetch(`${API_BASE}/api/v1/categories/recategorize`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        alert(`‚úÖ Recategorizaci√≥n completada!\n\nüìä Resultados:\n‚Ä¢ Tweets procesados: ${data.result.processed}\n‚Ä¢ Tweets actualizados: ${data.result.updated}`);
        loadCategories();
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Error en recategorizaci√≥n'}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error en recategorizaci√≥n');
    } finally {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
  
  // Initialize AI model
  async function initializeAI() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    const button = document.getElementById('initializeAI');
    const originalText = button.innerHTML;
    
    try {
      button.disabled = true;
      button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Cargando modelo...
      `;
      
      const response = await fetch(`${API_BASE}/api/v1/categories/initialize-ai`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        alert('‚úÖ Modelo de IA inicializado correctamente');
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Error inicializando IA'}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error inicializando IA');
    } finally {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
  
  // Toggle manual form
  function toggleManualForm() {
    const container = document.getElementById('manualFormContainer');
    const button = document.getElementById('toggleManualForm');
    const icon = button.querySelector('svg');
    
    if (container.classList.contains('hidden')) {
      container.classList.remove('hidden');
      icon.style.transform = 'rotate(180deg)';
    } else {
      container.classList.add('hidden');
      icon.style.transform = 'rotate(0deg)';
    }
  }
  
  // Event listeners
  document.getElementById('addCategoryForm')?.addEventListener('submit', addCategory);
  document.getElementById('autoCreateCategories')?.addEventListener('click', autoCreateCategories);
  document.getElementById('recategorizeTweets')?.addEventListener('click', recategorizeTweets);
  document.getElementById('initializeAI')?.addEventListener('click', initializeAI);
  document.getElementById('toggleManualForm')?.addEventListener('click', toggleManualForm);
  
  // Initialize page
  document.addEventListener('DOMContentLoaded', async () => {
    const isAuthenticated = await checkAuth();
    if (isAuthenticated) {
      loadCategories();
    }
  });
</script>
