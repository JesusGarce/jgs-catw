---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Tweets - Twitter Archiver">
  <div class="px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Tweets</h1>
      <p class="mt-2 text-gray-600">Explora y organiza todos tus tweets guardados.</p>
    </div>

    <!-- AI Categorization Controls -->
    <div class="card mb-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">ü§ñ Categorizaci√≥n Autom√°tica con IA</h3>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div>
          <button id="categorizeUncategorized" class="btn-primary w-full">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Categorizar Sin Categor√≠a
          </button>
          <p class="text-xs text-gray-500 mt-1">Categoriza solo tweets sin categor√≠a</p>
        </div>
        
        <div>
          <button id="recategorizeTweets" class="btn-secondary w-full">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Recategorizar Todos
          </button>
          <p class="text-xs text-gray-500 mt-1">Reclasifica todos tus tweets con IA</p>
        </div>
        
        <div>
          <button id="initializeAI" class="btn-outline w-full">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Inicializar IA
          </button>
          <p class="text-xs text-gray-500 mt-1">Cargar modelo de IA para categorizaci√≥n</p>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-6">
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Search -->
        <div>
          <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
          <input type="text" id="search" placeholder="Buscar en tweets..." class="input">
        </div>
        
        <!-- Category Filter -->
        <div>
          <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
          <select id="category" class="input">
            <option value="">Todas las categor√≠as</option>
          </select>
        </div>
        
        <!-- Sort By -->
        <div>
          <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-1">Ordenar por</label>
          <select id="sortBy" class="input">
            <option value="bookmarkedAt">Fecha de guardado</option>
            <option value="createdAtTwitter">Fecha del tweet</option>
            <option value="likeCount">Likes</option>
            <option value="retweetCount">Retweets</option>
          </select>
        </div>
        
        <!-- Sort Order -->
        <div>
          <label for="sortOrder" class="block text-sm font-medium text-gray-700 mb-1">Orden</label>
          <select id="sortOrder" class="input">
            <option value="desc">Descendente</option>
            <option value="asc">Ascendente</option>
          </select>
        </div>
      </div>
      
      <div class="mt-4 flex justify-between items-center">
        <button id="applyFilters" class="btn-primary">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
          </svg>
          Aplicar Filtros
        </button>
        
        <div class="text-sm text-gray-500">
          <span id="tweetCount">0</span> tweets encontrados
        </div>
      </div>
    </div>

    <!-- Tweets List -->
    <div id="tweetsContainer" class="space-y-4">
      <!-- Loading state -->
      <div id="loadingState" class="text-center py-12">
        <svg class="animate-spin mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2 text-gray-500">Cargando tweets...</p>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mt-8 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <button id="prevPage" class="btn-secondary" disabled>
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
          Anterior
        </button>
        <span class="text-sm text-gray-700">
          P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span>
        </span>
        <button id="nextPage" class="btn-secondary" disabled>
          Siguiente
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
      
      <div class="flex items-center space-x-2">
        <label for="pageSize" class="text-sm text-gray-700">Mostrar:</label>
        <select id="pageSize" class="input w-20">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
  </div>
</Layout>

<script>
  // API base URL
  const API_BASE = 'http://127.0.0.1:3001';
  
  // State
  let currentPage = 1;
  let pageSize = 20;
  let totalPages = 1;
  let totalTweets = 0;
  let categories = [];

  // Declarar funciones globales para TypeScript
  declare global {
    interface Window {
      recategorizeTweet: (tweetId: string) => Promise<void>;
      changeCategory: (tweetId: string) => Promise<void>;
    }
  }
  
  // Check authentication
  async function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
      window.location.href = '/';
      return false;
    }
    return true;
  }
  
  // Load categories
  async function loadCategories() {
    try {
      const token = localStorage.getItem('authToken');
      const response = await fetch(`${API_BASE}/api/v1/categories`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        categories = data.categories || [];
        
        const categorySelect = document.getElementById('category') as HTMLSelectElement;
        if (categorySelect) {
          categorySelect.innerHTML = '<option value="">Todas las categor√≠as</option>';
          
          categories.forEach((category: any) => {
            const option = document.createElement('option');
            option.value = category.name;
            option.textContent = category.name;
            categorySelect.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Error loading categories:', error);
    }
  }
  
  // Load tweets
  async function loadTweets() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    const searchEl = document.getElementById('search') as HTMLInputElement;
    const categoryEl = document.getElementById('category') as HTMLSelectElement;
    const sortByEl = document.getElementById('sortBy') as HTMLSelectElement;
    const sortOrderEl = document.getElementById('sortOrder') as HTMLSelectElement;
    
    const search = searchEl?.value || '';
    const category = categoryEl?.value || '';
    const sortBy = sortByEl?.value || 'bookmarkedAt';
    const sortOrder = sortOrderEl?.value || 'desc';
    
    // Show loading
    const loadingState = document.getElementById('loadingState');
    const tweetsContainer = document.getElementById('tweetsContainer');
    
    if (loadingState) loadingState.style.display = 'block';
    if (tweetsContainer) tweetsContainer.innerHTML = '';
    
    try {
      const params = new URLSearchParams({
        page: currentPage.toString(),
        limit: pageSize.toString(),
        sortBy,
        sortOrder
      });
      
      if (search) params.append('search', search);
      if (category) params.append('category', category);
      
      const response = await fetch(`${API_BASE}/api/v1/tweets?${params}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        displayTweets(data.tweets);
        updatePagination(data.pagination);
      } else {
        throw new Error('Error loading tweets');
      }
    } catch (error) {
      console.error('Error:', error);
      const tweetsContainer = document.getElementById('tweetsContainer');
      if (tweetsContainer) {
        tweetsContainer.innerHTML = `
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <p class="mt-2 text-gray-500">Error cargando tweets</p>
          </div>
        `;
      }
    } finally {
      const loadingState = document.getElementById('loadingState');
      if (loadingState) {
        loadingState.style.display = 'none';
      }
    }
  }
  
  // Display tweets
  function displayTweets(tweets: any[]) {
    const container = document.getElementById('tweetsContainer');
    
    if (!container) return;
    
    if (!tweets || tweets.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
          </svg>
          <p class="mt-2 text-gray-500">No se encontraron tweets</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = tweets.map((tweet: any) => `
      <div class="card hover:shadow-md transition-shadow">
        <div class="flex items-start space-x-4">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-twitter-600 rounded-full flex items-center justify-center">
              <span class="text-white font-medium">${tweet.authorUsername.charAt(0).toUpperCase()}</span>
            </div>
          </div>
          
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-900">${tweet.authorUsername}</span>
                <span class="text-sm text-gray-500">${new Date(tweet.createdAtTwitter).toLocaleDateString()}</span>
                ${tweet.categories && tweet.categories.length > 0 ? 
                  tweet.categories.map((cat: any) => 
                    `<span class="badge ${cat.isPrimary ? 'badge-primary' : 'badge-secondary'} mr-1" style="background-color: ${cat.color || '#6B7280'}; color: white;">
                      ${cat.name}
                      ${cat.confidence ? `<span class="text-xs opacity-75">(${Math.round(cat.confidence * 100)}%)</span>` : ''}
                    </span>`
                  ).join('') : 
                  '<span class="badge badge-warning">Sin categor√≠a</span>'
                }
              </div>
              
              <div class="flex items-center space-x-2">
                <button onclick="recategorizeTweet('${tweet.id}')" class="text-sm text-green-600 hover:text-green-800" title="Recategorizar con IA">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
                </button>
                <button onclick="changeCategory('${tweet.id}')" class="text-sm text-primary-600 hover:text-primary-800" title="Cambiar categor√≠a manualmente">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                  </svg>
                </button>
                <a href="https://twitter.com/${tweet.authorUsername}/status/${tweet.tweetId}" target="_blank" class="text-sm text-gray-500 hover:text-gray-700">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                </a>
              </div>
            </div>
            
            <p class="text-gray-900 mb-3">${tweet.content}</p>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4 text-sm text-gray-500">
                <span>‚ù§Ô∏è ${tweet.likeCount}</span>
                <span>üîÑ ${tweet.retweetCount}</span>
                <span>üí¨ ${tweet.replyCount}</span>
              </div>
              
              <div class="text-xs text-gray-400">
                Guardado: ${new Date(tweet.bookmarkedAt).toLocaleDateString()}
              </div>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // Update pagination
  function updatePagination(pagination: any) {
    currentPage = pagination.currentPage;
    totalPages = pagination.totalPages;
    totalTweets = pagination.totalItems;
    
    const currentPageEl = document.getElementById('currentPage');
    const totalPagesEl = document.getElementById('totalPages');
    const tweetCountEl = document.getElementById('tweetCount');
    const prevPageEl = document.getElementById('prevPage') as HTMLButtonElement;
    const nextPageEl = document.getElementById('nextPage') as HTMLButtonElement;
    
    if (currentPageEl) currentPageEl.textContent = currentPage.toString();
    if (totalPagesEl) totalPagesEl.textContent = totalPages.toString();
    if (tweetCountEl) tweetCountEl.textContent = totalTweets.toString();
    
    if (prevPageEl) prevPageEl.disabled = !pagination.hasPrev;
    if (nextPageEl) nextPageEl.disabled = !pagination.hasNext;
  }
  
  // Recategorize tweet with AI - Global function
  window.recategorizeTweet = async function(tweetId) {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    if (!confirm('¬øRecategorizar este tweet usando IA?')) return;
    
    try {
      const response = await fetch(`${API_BASE}/api/v1/tweets/${tweetId}/categorize`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        alert(`‚úÖ Tweet recategorizado!\n\nCategor√≠as asignadas:\n${data.categories.map((cat: any) => `‚Ä¢ ${cat.name} (${Math.round(cat.confidence * 100)}%)`).join('\n')}`);
        loadTweets(); // Reload tweets
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Error recategorizando tweet'}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error recategorizando tweet');
    }
  }

  // Change category (legacy function for compatibility) - Global function
  window.changeCategory = async function(tweetId) {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    const category = prompt('Ingresa la nueva categor√≠a principal:');
    if (!category) return;
    
    try {
      // Crear estructura de categor√≠as m√∫ltiples
      const categories = [{
        category: category,
        confidence: 0.8,
        isPrimary: true
      }];

      const response = await fetch(`${API_BASE}/api/v1/tweets/${tweetId}/categories`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ categories })
      });
      
      if (response.ok) {
        loadTweets(); // Reload tweets
      } else {
        alert('Error actualizando categor√≠a');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error actualizando categor√≠a');
    }
  }

  // Categorize only uncategorized tweets
  async function categorizeUncategorized() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    if (!confirm('¬øCategorizar solo los tweets que a√∫n no tienen categor√≠a asignada?')) {
      return;
    }
    
    const button = document.getElementById('categorizeUncategorized') as HTMLButtonElement;
    if (!button) return;
    
    const originalText = button.innerHTML;
    
    try {
      button.disabled = true;
      button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Categorizando...
      `;
      
      const response = await fetch(`${API_BASE}/api/v1/categories/categorize-uncategorized`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        alert(`‚úÖ Categorizaci√≥n completada!\n\nüìä Resultados:\n‚Ä¢ Tweets sin categor√≠a encontrados: ${data.result.found}\n‚Ä¢ Tweets categorizados: ${data.result.categorized}\n‚Ä¢ Tweets procesados: ${data.result.processed}`);
        loadTweets(); // Reload tweets
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Error en categorizaci√≥n'}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error en categorizaci√≥n');
    } finally {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }

  // Recategorize all tweets
  async function recategorizeTweets() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    if (!confirm('¬øEst√°s seguro de que quieres recategorizar todos tus tweets? Esto puede tomar varios minutos.')) {
      return;
    }
    
    const button = document.getElementById('recategorizeTweets') as HTMLButtonElement;
    if (!button) return;
    
    const originalText = button.innerHTML;
    
    try {
      button.disabled = true;
      button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Recategorizando...
      `;
      
      const response = await fetch(`${API_BASE}/api/v1/categories/recategorize`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        alert(`‚úÖ Recategorizaci√≥n completada!\n\nüìä Resultados:\n‚Ä¢ Tweets procesados: ${data.result.processed}\n‚Ä¢ Tweets actualizados: ${data.result.updated}`);
        loadTweets(); // Reload tweets
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Error en recategorizaci√≥n'}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error en recategorizaci√≥n');
    } finally {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
  
  // Initialize AI model
  async function initializeAI() {
    const token = localStorage.getItem('authToken');
    if (!token) return;
    
    const button = document.getElementById('initializeAI') as HTMLButtonElement;
    if (!button) return;
    
    const originalText = button.innerHTML;
    
    try {
      button.disabled = true;
      button.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Cargando modelo...
      `;
      
      const response = await fetch(`${API_BASE}/api/v1/categories/initialize-ai`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        alert('‚úÖ Modelo de IA inicializado correctamente');
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Error inicializando IA'}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error inicializando IA');
    } finally {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }
  
  // Event listeners
  document.getElementById('applyFilters')?.addEventListener('click', () => {
    currentPage = 1;
    loadTweets();
  });
  
  document.getElementById('categorizeUncategorized')?.addEventListener('click', categorizeUncategorized);
  document.getElementById('recategorizeTweets')?.addEventListener('click', recategorizeTweets);
  document.getElementById('initializeAI')?.addEventListener('click', initializeAI);
  
  document.getElementById('prevPage')?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      loadTweets();
    }
  });
  
  document.getElementById('nextPage')?.addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++;
      loadTweets();
    }
  });
  
  document.getElementById('pageSize')?.addEventListener('change', (e) => {
    const target = e.target as HTMLSelectElement;
    if (target) {
      pageSize = parseInt(target.value);
      currentPage = 1;
      loadTweets();
    }
  });
  
  // Initialize page
  document.addEventListener('DOMContentLoaded', async () => {
    const isAuthenticated = await checkAuth();
    if (isAuthenticated) {
      await loadCategories();
      loadTweets();
    }
  });
</script>
